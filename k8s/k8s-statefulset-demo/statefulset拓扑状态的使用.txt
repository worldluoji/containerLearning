1. Deploymentåªèƒ½ç”¨äºæ— çŠ¶æ€åº”ç”¨çš„ç¼–æ’ï¼Œè€ŒStatefulSetç”¨äºæœ‰çŠ¶æ€åº”ç”¨çš„ç¼–æ’

2. StatefulSetæŠŠç°å®ä¸–ç•Œä¸­çš„â€œæœ‰çŠ¶æ€åº”ç”¨â€åˆ†ä¸ºä¸¤ç±»ï¼š
	1).æ‹“æ‰‘çŠ¶æ€ï¼šå³åº”ç”¨å¤šä¸ªå®ä¾‹ä¹‹é—´çš„å…³ç³»ä¸å¯¹ç­‰ï¼Œæ¯”å¦‚POD Aè¦å…ˆäºPOD Bå¯åŠ¨ã€‚åˆ é™¤ABä¸¤ä¸ªPODï¼Œé‚£ä¹ˆæ¢å¤æ—¶ï¼Œä¹Ÿå¿…é¡»å…ˆAåB
	2).å­˜å‚¨çŠ¶æ€ã€‚POD Aè¯»å–åˆ°çš„å­˜å‚¨æ•°æ®ï¼Œå“ªæ€•è¿‡äº†10åˆ†é’Ÿåï¼Œç”šè‡³PODè¢«é‡æ–°åˆ›å»ºè¿‡ï¼Œä¹Ÿèƒ½è¯»å–åˆ°åŒæ ·è·¯å¾„çš„æ•°æ®
StatefulSetå°±æ˜¯è®°å½•ä¸‹è¿™äº›çŠ¶æ€ï¼Œä»¥ä¾¿PODé‡å»ºæ—¶èƒ½æ¢å¤è¿™äº›çŠ¶æ€


3.  "Normal Service"å’Œ"Headless Serviceâ€œçš„åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ
Headless Serviceä¸éœ€è¦åˆ†é…ä¸€ä¸ª VIPï¼Œè€Œæ˜¯å¯ä»¥ç›´æ¥ä»¥ DNS è®°å½•çš„æ–¹å¼è§£æå‡ºè¢«ä»£ç† Pod çš„ IP åœ°å€ï¼Œ
åŒæ—¶ç”±äºå…¶ç¼–å·çš„ä¸¥æ ¼è§„å®šï¼Œä¼šæŒ‰ç…§ç¼–å·é¡ºåºå®Œæˆåˆ›å»ºå·¥ä½œã€‚
å¦‚æœåœ¨éƒ¨ç½²StatefulSetçš„æ—¶å€™ï¼Œå¿…é¡»ä½¿ç”¨"Headless Service" ï¼Œè€Œä¸æ˜¯"Normal Service"ã€‚
æ‰€è°“çš„ Headless Serviceï¼Œå…¶å®ä»æ˜¯ä¸€ä¸ªæ ‡å‡† Service çš„ YAML æ–‡ä»¶ã€‚åªä¸è¿‡ï¼Œå®ƒçš„ clusterIP å­—æ®µçš„å€¼æ˜¯ï¼šNoneï¼Œ
å³ï¼šè¿™ä¸ª Serviceï¼Œæ²¡æœ‰ä¸€ä¸ª VIP ä½œä¸ºâ€œå¤´â€ã€‚è¿™ä¹Ÿå°±æ˜¯ Headless çš„å«ä¹‰ã€‚
æ‰€ä»¥ï¼Œè¿™ä¸ª Service è¢«åˆ›å»ºåå¹¶ä¸ä¼šè¢«åˆ†é…ä¸€ä¸ª VIPï¼Œè€Œæ˜¯ä¼šä»¥ DNS è®°å½•çš„æ–¹å¼æš´éœ²å‡ºå®ƒæ‰€ä»£ç†çš„ Podã€‚


4. ä¸€ä¸ªä¾‹å­
$ kubectl create -f statefulset-demo.yaml
$ kubectl get service nginx
NAME      TYPE         CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
nginx     ClusterIP    None         <none>        80/TCP    10s
$ kubectl get statefulset web
NAME      DESIRED   CURRENT   AGE
web       2         1         19s



$ kubectl get pods -w -l app=nginx
NAME      READY     STATUS    RESTARTS   AGE
web-0     0/1       Pending   0          0s
web-0     0/1       Pending   0         0s
web-0     0/1       ContainerCreating   0         0s
web-0     1/1       Running   0         19s
web-1     0/1       Pending   0         0s
web-1     0/1       Pending   0         0s
web-1     0/1       ContainerCreating   0         0s
web-1     1/1       Running   0         20s

å¯è§ï¼Œè¿™äº›PODçš„åˆ›å»ºæ˜¯ä¸¥æ ¼æŒ‰ç…§é¡ºåºè¿›è¡Œçš„ï¼Œweb-0è¿›å…¥RunningçŠ¶æ€åï¼Œweb-1æ‰å¼€å§‹åˆ›å»ºã€‚
kubectl çš„ -w å‚æ•°ï¼Œå³ï¼šWatch åŠŸèƒ½ï¼Œå®æ—¶æŸ¥çœ‹ StatefulSet åˆ›å»ºä¸¤ä¸ªæœ‰çŠ¶æ€å®ä¾‹çš„è¿‡ç¨‹ã€‚
æ›´é‡è¦çš„æ˜¯ï¼Œè¿™äº› Pod çš„åˆ›å»ºï¼Œä¹Ÿæ˜¯ä¸¥æ ¼æŒ‰ç…§ç¼–å·é¡ºåºè¿›è¡Œçš„ã€‚
æ¯”å¦‚ï¼Œåœ¨ web-0 è¿›å…¥åˆ° Running çŠ¶æ€ã€å¹¶ä¸”ç»†åˆ†çŠ¶æ€ï¼ˆConditionsï¼‰æˆä¸º Ready ä¹‹å‰ï¼Œweb-1 ä¼šä¸€ç›´å¤„äº Pending çŠ¶æ€ã€‚
é€šè¿‡è¿™ç§æ–¹æ³•ï¼ŒKubernetes å°±æˆåŠŸåœ°å°† Pod çš„æ‹“æ‰‘çŠ¶æ€ï¼ˆæ¯”å¦‚ï¼šå“ªä¸ªèŠ‚ç‚¹å…ˆå¯åŠ¨ï¼Œå“ªä¸ªèŠ‚ç‚¹åå¯åŠ¨ï¼‰ï¼ŒæŒ‰ç…§ Pod çš„â€œåå­— + ç¼–å·â€çš„æ–¹å¼å›ºå®šäº†ä¸‹æ¥ã€‚
æ­¤å¤–ï¼ŒKubernetes è¿˜ä¸ºæ¯ä¸€ä¸ª Pod æä¾›äº†ä¸€ä¸ªå›ºå®šå¹¶ä¸”å”¯ä¸€çš„è®¿é—®å…¥å£ï¼Œå³ï¼šè¿™ä¸ª Pod å¯¹åº”çš„ DNS è®°å½•ã€‚

å¦‚æœæˆ‘ä»¬å†ç”¨ nslookup å‘½ä»¤ï¼ŒæŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–° Pod å¯¹åº”çš„ Headless Serviceï¼š
$ kubectl run -i --tty --image busybox dns-test --restart=Never --rm /bin/sh 
$ nslookup web-0.nginx
Server:    10.0.0.10
Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      web-0.nginx
Address 1: 10.244.1.8

$ nslookup web-1.nginx
Server:    10.0.0.10
Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      web-1.nginx
Address 1: 10.244.2.8
ä¸è¿‡ï¼Œç›¸ä¿¡ä½ ä¹Ÿå·²ç»æ³¨æ„åˆ°äº†ï¼Œå°½ç®¡ web-0.nginx è¿™æ¡è®°å½•æœ¬èº«ä¸ä¼šå˜ï¼Œä½†å®ƒè§£æåˆ°çš„ Pod çš„ IP åœ°å€ï¼Œå¹¶ä¸æ˜¯å›ºå®šçš„ã€‚
è¿™å°±æ„å‘³ç€ï¼Œå¯¹äºâ€œæœ‰çŠ¶æ€åº”ç”¨â€å®ä¾‹çš„è®¿é—®ï¼Œä½ å¿…é¡»ä½¿ç”¨ DNS è®°å½•æˆ–è€… hostname çš„æ–¹å¼ï¼Œè€Œç»ä¸åº”è¯¥ç›´æ¥è®¿é—®è¿™äº› Pod çš„ IP åœ°å€ã€‚

é—®é¢˜:
** server can't find web-0.nginx: NXDOMAIN
*** Can't find web-0.nginx: No answer
ä½†æ˜¯ç›´æ¥ping web-0.nginx æ˜¯å¯ä»¥è·å–çœŸå®ipåœ°å€çš„.
ç¡®å®æ˜¯å¦‚æ¥¼ä¸‹çš„åŒå­¦æ‰€è¯´, éœ€è¦ç”¨ busybox:1.28.4 çš„é•œåƒ. è¿™ä¸ªæ˜¯æœ€æ–°ç‰ˆbusyboxçš„é—®é¢˜.
kubectl run -i --tty --image busybox:1.28.4 dns-test --restart=Never --rm /bin/sh
è¿™æ ·å°±å¯è·å¾—æœŸå¾…çš„ç»“æœäº†.
æˆ‘ä¹Ÿæ˜¯googleåˆ°äº† https://github.com/kubernetes/kubernetes/issues/66924 æ‰çŸ¥é“çš„.
å†çœ‹æ¥¼ä¸‹çš„è¯„è®º,æ‰å‘ç°æœ‰å…¶ä»–åŒå­¦ä¹Ÿé‡åˆ°äº†,ä¸”åœ¨å‡ å¤©å‰å·²ç»ç»™å‡ºäº†è§£å†³æ–¹æ¡ˆ. ğŸ‘
æ–°æŠ€æœ¯ç¡®å®å˜åŒ–å¤ªå¿«äº†,ä½œè€…åœ¨å†™æ–‡ç« æ—¶ç”¨çš„æ²¡é—®é¢˜,ä¹Ÿè®¸éš”ä¸€å¤©å› ä¸ºæŸä¸ªé»˜è®¤é•œåƒä¿®æ”¹äº†,å°±ä¼šå‡ºç°æ–°çš„çŠ¶å†µ.